<?xml version="1.0" encoding="UTF-8"?>
<ContentPage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:ffimageloading="clr-namespace:FFImageLoading.Forms;assembly=FFImageLoading.Forms"
             xmlns:fftransformations="clr-namespace:FFImageLoading.Transformations;assembly=FFImageLoading.Transformations"
             xmlns:views="clr-namespace:Osma.Mobile.App.Views.ProofRequests;assembly=Osma.Mobile.App"
             xmlns:ios="clr-namespace:Xamarin.Forms.PlatformConfiguration.iOSSpecific;assembly=Xamarin.Forms.Core"
             xmlns:resources="clr-namespace:Osma.Mobile.App"
             xmlns:behaviours="clr-namespace:Osma.Mobile.App.Behaviors"
             xmlns:converters="clr-namespace:Osma.Mobile.App.Converters"
             x:Class="Osma.Mobile.App.Views.ProofRequests.ProofRequestPage"
             x:Name="ProofRequestView"
             Title="{Binding ProofName}"
             ios:Page.UseSafeArea="true">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBooleanConverter x:Key="BooleanInverse" />
            <converters:SelecteditemEventArgsToSelectedItemConverter x:Key="SelectedItemConverter" />
            <converters:StringCaseConverter x:Key="StringCase" />
            <DataTemplate x:Key="detailCell">
                <ViewCell>
                    <ViewCell.View>
                        <Grid Padding="24">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="50"></ColumnDefinition>
                                <ColumnDefinition Width="*"></ColumnDefinition>
                                <ColumnDefinition Width="Auto"></ColumnDefinition>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"></RowDefinition>
                                <RowDefinition Height="Auto"></RowDefinition>
                            </Grid.RowDefinitions>
                            <ffimageloading:CachedImage Grid.Row="0"    
                                                        Grid.Column="0"
                                                        Grid.RowSpan="2"
                                                        VerticalOptions="Center"
                                                        HeightRequest="50"
                                                        WidthRequest="50"
                                                        FadeAnimationEnabled="true"
                                                        DownsampleUseDipUnits="true"
                                                        Aspect="Fill">
                                <ffimageloading:CachedImage.Transformations>
                                    <fftransformations:CircleTransformation/>
                                </ffimageloading:CachedImage.Transformations>
                            </ffimageloading:CachedImage>
                            <Label Grid.Row="0"
                                   Grid.Column="1"
                                   VerticalOptions="Center"
                                   FontSize="Medium"
                                   Text="{Binding Name}"/>
                            <Label Grid.Row="1"
                                   Grid.Column="1"
                                   VerticalOptions="Center"
                                   FontSize="Small"
                                   Text="{Binding Value}"/>
                            <Label Grid.Row="0"
                                   Grid.Column="2"
                                   VerticalOptions="Center"
                                   FontSize="Small"
                                   Text="{Binding RevealDataLabel}"
                                   IsVisible="{Binding IsNotPredicate}"/>
                            <Switch Grid.Row="1"
                                    Grid.RowSpan="2"
                                    Grid.Column="2"
                                    IsToggled="{Binding IsRevealed}"
                                    IsVisible="{Binding IsNotPredicate}"
                                    VerticalOptions="Center">
                                <Switch.Behaviors>
                                    <behaviours:EventToCommandBehavior 
                                        EventName="Toggled" 
                                        Command="{Binding Path=BindingContext.ToggledCommand, Source={x:Reference ProofRequestView}}"
								        CommandParameter="{Binding .}"/>
                                </Switch.Behaviors>
                            </Switch>
                        </Grid>
                    </ViewCell.View>
                </ViewCell>
            </DataTemplate>
            <DataTemplate x:Key="textTemplate">
                <ViewCell >
                    <StackLayout Padding="24, 16">
                        <Label Text="textTemplate"
                               FontSize="Small"/>
                        <Label Text="{Binding Name}"
                               FontSize="Small"/>
                        <Label Text="{Binding Value}"
                               FontSize="Medium"
                               FontAttributes="Bold"/>
                    </StackLayout>
                </ViewCell>
            </DataTemplate>
            <DataTemplate x:Key="nameTemplate">
                <ViewCell>
                    <StackLayout Padding="24, 16">
                        <Label Text="nameTemplate"
                               FontSize="Small"/>
                        <Label Text="{Binding Name}"
                               FontSize="Small"/>
                    </StackLayout>
                </ViewCell>
            </DataTemplate>
            <DataTemplate x:Key="proofCredentialTemplate">
                <ViewCell>
                    <StackLayout Padding="24, 16">
                        <Label FontSize="Medium" TextColor="Black" Text="{Binding SchemaName}"/>
                        <Label FontSize="Small" Text="{Binding IssuedAt, StringFormat='Issued {0:d}'}"/>
                        <!--<Label Text="{Binding AttributeName}"/>-->
                        <Label TextColor="Black" Text="{Binding AttributeValue}"/>
                    </StackLayout>
                </ViewCell>
            </DataTemplate>
            <DataTemplate x:Key="fileTemplate">
                <ViewCell>
                    <StackLayout Padding="24, 16">
                        <Label Text="{Binding Name}"
                               FontSize="Small" />
                        <Frame HeightRequest="141.3"
                               WidthRequest="100"
                               HorizontalOptions="Start">
                            <Frame HasShadow="false"
                                   BackgroundColor="Gray"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"
                                   Padding="6, 3">
                                <Label HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       TextColor="White"
                                       Text="{Binding FileExt}"
                                       FontSize="Default"
                                       FontAttributes="Bold"/>
                            </Frame>
                        </Frame>
                        <Label Text="{Binding Date}"
                               FontSize="Small"/>
                    </StackLayout>
                </ViewCell>
            </DataTemplate>
            <DataTemplate x:Key="errorTemplate">
                <ViewCell>
                    <StackLayout >
                        <Label
                            Text="{Binding ErrorLabel}" />
                    </StackLayout>
                </ViewCell>
            </DataTemplate>
            <views:ProofRequestAttributeTemplateSelector x:Key="proofRequestAttributeTemplateSelector"
                                                         TextTemplate="{StaticResource textTemplate}"
                                                         FileTemplate="{StaticResource fileTemplate}"
                                                         NameTemplate="{StaticResource nameTemplate}"
                                                         ErrorTemplate="{StaticResource errorTemplate}"/>
            <views:ProofRequestCredentialTemplateSelector x:Key="proofRequestCredentialTemplateSelector"
                                                          TextTemplate="{StaticResource proofCredentialTemplate}"/>
        </ResourceDictionary>
    </ContentPage.Resources>
    <ContentPage.Content>
        <AbsoluteLayout Padding="0" HorizontalOptions="FillAndExpand" VerticalOptions="FillAndExpand">
            <StackLayout AbsoluteLayout.LayoutBounds="0, 0, 1, 1" AbsoluteLayout.LayoutFlags="All">
                <StackLayout>
                   <Grid Padding="16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="50"></ColumnDefinition>
                            <ColumnDefinition Width="*"></ColumnDefinition>
                            <ColumnDefinition Width="Auto"></ColumnDefinition>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"></RowDefinition>
                            <RowDefinition Height="Auto"></RowDefinition>
                            <RowDefinition Height="Auto"></RowDefinition>
                            <RowDefinition Height="Auto"></RowDefinition>
                        </Grid.RowDefinitions>
                        <ffimageloading:CachedImage Grid.Row="0"
                                                    Grid.Column="0"
                                                    Grid.RowSpan="2"
                                                    VerticalOptions="Center"
                                                    HeightRequest="50"
                                                    WidthRequest="50"
                                                    FadeAnimationEnabled="true"
                                                    DownsampleUseDipUnits="true"
                                                    Aspect="Fill"
                                                    Source="{ Binding ProofRequesImagetUrl }">
                            <ffimageloading:CachedImage.Transformations>
                                <fftransformations:CircleTransformation />
                            </ffimageloading:CachedImage.Transformations>
                        </ffimageloading:CachedImage>
                        <ffimageloading:CachedImage Grid.Row="2"
                                                    Grid.Column="0"
                                                    Grid.RowSpan="2"
                                                    VerticalOptions="Center"
                                                    HeightRequest="50"
                                                    WidthRequest="50"
                                                    FadeAnimationEnabled="true"
                                                    DownsampleUseDipUnits="true"
                                                    Aspect="Fill"
                                                    Source="{ Binding ProofRequesImagetUrl }">
                            <ffimageloading:CachedImage.Transformations>
                                <fftransformations:CircleTransformation />
                            </ffimageloading:CachedImage.Transformations>
                        </ffimageloading:CachedImage>
                        <Label Grid.Row="0"
                               Grid.Column="1"
                               FontSize="Medium"
                               FontAttributes="Bold"
                               Text="{Binding ProofName}"/>
                        <Label Grid.Row="1"
                               Grid.Column="1"
                               Text="{x:Static resources:AppResources.DigitalProofRequestLabel}"
                               FontSize="Default"/>
                        <Label Grid.Row="2"
                               Grid.Column="1"
                               FontSize="Large"
                               FontAttributes="Bold"
                               Text="{Binding ProofVersion}"/>
                        <ffimageloading:CachedImage Grid.Row="2"
                                                    Grid.Column="2"
                                                    Grid.RowSpan="2"
                                                    VerticalOptions="Center"
                                                    HeightRequest="50"
                                                    WidthRequest="50"
                                                    FadeAnimationEnabled="true"
                                                    DownsampleUseDipUnits="true"
                                                    Aspect="Fill"
                                                    Source="{ Binding QRImageUrl }">
                        </ffimageloading:CachedImage>
                    </Grid>
                    <ListView SeparatorVisibility="None"
                              BackgroundColor="#eee"
                              ItemTemplate="{StaticResource detailCell}"
                              ItemsSource="{Binding Attributes}"
                              HasUnevenRows="true"
                              IsPullToRefreshEnabled="true"
                              IsRefreshing="{Binding RefreshingProofRequest}"
                              RefreshCommand="{Binding RefreshCommand}"
                              IsEnabled="{Binding RefreshingProofRequest, Converter={StaticResource BooleanInverse}}">
                        <ListView.Behaviors>
                            <behaviours:EventToCommandBehavior EventName="ItemSelected" Command="{Binding SelectProofAttributeCommand}" Converter="{StaticResource SelectedItemConverter}" DeselectOnClick="true"/>
                        </ListView.Behaviors>
                    </ListView>
                    <StackLayout
                        IsVisible="{Binding AreButtonsVisible}">
                        <Button HorizontalOptions="FillAndExpand"
                                Text="{x:Static resources:AppResources.AcceptProofRequestButtonLabel}"
                                Command="{Binding AcceptProofRequestCommand}"
                                Style="{StaticResource ButtonStyleAccept}"/>
                        <Button HorizontalOptions="FillAndExpand"
                                Text="{x:Static resources:AppResources.RefuseProofRequestButtonLabel}"
                                Command="{Binding RejectProofRequestCommand}"
                                Style="{StaticResource ButtonStyleDestructive}"/>
                    </StackLayout>
                </StackLayout>
            </StackLayout>
            <ContentView x:Name="popupAttributeValueSelector" 
                         BackgroundColor="#C0808080" 
                         Padding="30, 30" 
                         IsVisible="{Binding IsFrameVisible}" 
                         AbsoluteLayout.LayoutBounds="0, 0, 1, 1" 
                         AbsoluteLayout.LayoutFlags="All">
                <StackLayout VerticalOptions="Center" HorizontalOptions="FillAndExpand">
                    <StackLayout Orientation="Vertical" HeightRequest="400" BackgroundColor="White">
                        <Label FontSize="Medium" Margin="10,10,10,20"
                               TextColor="Black"
                               Text="{x:Static resources:AppResources.SelectAttributeValueTitle}"
                               FontAttributes="Bold"
                               HorizontalTextAlignment="Center"/>
                        <Label Margin="10,0,10,20"
                               TextColor="Gray"
                               Text="1 disponible"
                               HorizontalTextAlignment="Center"/>
                        <Label Margin="10,0,10,10"
                               TextColor="Black"
                               Text="{Binding SelectedAttributeName}"
                               HorizontalTextAlignment="Center"/>
                        <ListView SeparatorVisibility="None"
                                  BackgroundColor="Transparent"
                                  ItemTemplate="{StaticResource proofRequestCredentialTemplateSelector}"
                                  ItemsSource="{Binding ProofCredentials}"
                                  HasUnevenRows="true">
                            <ListView.Behaviors>
                                <behaviours:EventToCommandBehavior EventName="ItemSelected" Command="{Binding SelectProofCredentialCommand}" Converter="{StaticResource SelectedItemConverter}" DeselectOnClick="true"/>
                            </ListView.Behaviors>
                        </ListView>
                    </StackLayout>
                </StackLayout>
            </ContentView>
        </AbsoluteLayout>
    </ContentPage.Content>
</ContentPage>